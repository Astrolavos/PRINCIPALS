
TARGET="coastalbrezecarwash.com"
BLOCKFILE="/home/kevinv/PRINCIPALS/gt/vm_management/blocklist2"
f="/home/kevinv/malware_folder/bazarloader/8e244f1a5b4653d6dbb4cc3978c7dd773b227a443361fbc30265b79f102f7eed.exe"
DUMMY_FILE="/home/kevinv/malware_folder/fake-malware.bat"
BASENAME=$(basename $f)
IDENTIFIER=${BASENAME:0:5}
MONITOR_CONTAINER="generic-monitor"

echo " * Checking for target"
while ! tshark -r malware_$IDENTIFIER.pcap -Y dns | grep -q $TARGET
do
  kubectl cp default/$MONITOR_CONTAINER:/malware_generic.pcap malware_$IDENTIFIER.pcap
  echo "  * Checking again"
done
echo " * Found target domain"

# Now to pull up the mitm 
# cp $BLOCKFILE /home/thomas/v-mitm-test/scripts/blockfile
# pull up the mitm
VM_IP=$(kubectl get pod -owide | grep win10vm-$IDENTIFIER | tr -s ' ' | cut -d' ' -f 6 )
echo " * Pulling up mitm pod mitm-$IDENTIFIER monitoring $VM_IP"
MITM_CONTAINER=mitm-$IDENTIFIER
/home/thomas/v-mitm-test/pod_spawn.sh $MITM_CONTAINER $VM_IP v-mitm-test/scripts # You must be running as Thomas
