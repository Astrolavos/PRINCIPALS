#!/bin/bash
# Use this script to create a container that will be used to capture traffic from the vm
# using the given identifier.

set -e
IDENTIFIER=$1

MONITOR_CONTAINER=$IDENTIFIER-monitor
echo " * Begin redirection"
echo "  * Creating monitoring container $MONITOR_CONTAINER"
# Assumes the mitm-image is already built
echo "apiVersion: v1
kind: Pod
metadata:
  name: $MONITOR_CONTAINER
spec:
  serviceAccountName: monitoring-account
  containers:
  - name: mitm
    image: mitm-image
    command: [\"tcpdump\"]
    args: [\"-i\", \"eth0\", \"-vv\" ,\"-Z\", \"root\", \"-w\", \"malware_$IDENTIFIER.pcap\", \"udp\", \"and\", \"port\", \"53\"]
    imagePullPolicy: Never
    securityContext:
      privileged: true
      capabilities:
        add: ["NET_ADMIN"]
" > $MONITOR_CONTAINER.yaml

kubectl create -f $MONITOR_CONTAINER.yaml 

kubectl wait --for=condition=ready pod $MONITOR_CONTAINER --timeout=30s
echo " ! Created monitor $MONITOR_CONTAINER"

# Redirect traffic to this pod
# echo "  * Redirecting traffic from win10vm-$IDENTIFIER to $MONITOR_CONTAINER"
# script_full_path=$(dirname "$0")

# $script_full_path/redirect_traffic.sh virt-launcher-win10vm-$IDENTIFIER $MONITOR_CONTAINER
