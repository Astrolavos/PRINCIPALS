MALWARE_PCAP=$1
BENIGN_PCAP="/home/kevinv/PRINCIPALS/gt/vm_management/win10_pcaps/win10traffic_run2.pcap"

# ip addresses
# tshark -r $MALWARE_PCAP -T fields -e ip.dst | sort | uniq > malware_dest.txt

# domains
# tshark -nr $BENIGN_PCAP -Y "dns.flags.response == 0" -T fields -e dns.qry.name | sort | uniq > benign_domains.txt
tshark -nr $MALWARE_PCAP -Y "dns.flags.response == 0" -T fields -e dns.qry.name 2> /dev/null | sort | uniq > malware_domains.txt

# Get those unique to malware domains
# Example domains that are different in benign and malware
# campus-kms.gtm.gatech.edu
# cp501.prod.do.dsp.mp.microsoft.com
# kv501.prod.do.dsp.mp.microsoft.com
# _ldap._tcp.dc._msdcs.WORKGROUP.gatech.edu
# mddrgrw.cn
# pv.sohu.com
# qssbnqaghynpcxk.cluster.local
# qssbnqaghynpcxk.default.svc.cluster.local
# qssbnqaghynpcxk.gatech.edu
# qssbnqaghynpcxk.svc.cluster.local
# _VLMCS._TCP.gatech.edu
# wpad.gatech.edu

# *prod.do.dsp.mp.microsoft.com*  Used for Windows Update downloads of apps and OS updates
# *au.download.windowsupdate.com  Windows update stuff
# *.smartscreen.microsoft.com*    Windows Defender Smartscreen
# https://docs.microsoft.com/en-us/windows/privacy/windows-endpoints-1903-non-enterprise-editions
echo " * $1"
comm -23 malware_domains.txt benign_domains.txt | grep -v ".gatech.edu$" | grep -v ".cluster.local$" | grep -v ".prod.do.dsp.mp.microsoft.com$" | grep -v ".download.windowsupdate.com$" | grep -v "smartscreen-prod.microsoft.com$" | grep -v ".microsoft.com$" | grep -v "digicert.com" | grep -v "publicsuffix.org"


