# Overview
This contains code that will allow your to run malware in a Windows vm.

# Setting up Windows VMs for Running Malware
In order to complete the setup of a new VM image that can be used to run malware, you must
 1) Create the VM+
 2) Setup virtio drivers
 3) Set up autorun for malware
 4) Upload VM image to kubernetes
 5) Create Virtual Machines using kubevirt



## Installing Windows on VM
There are many instructions for installing windows on a VM. Find an ISO disk image for installing windows, and create a KVM/QEMU Virtual machine. We use KVM/QEMU to be consistent, since we will plan to be able to run other architectures in our VM setup. There also may be restrictions on what kinds of VM image formats are acceptable (we can confirm that QCOW2 works)
You can choose to install the virtio drivers either at installation or after installation. You will not be able to access internet on kubernetes through the VM without installing the virtio drivers.

## Setting up virtio drivers
https://pve.proxmox.com/wiki/Windows_VirtIO_Drivers
https://kubevirt.io/user-guide/virtual_machines/windows_virtio_drivers/
Essentially, find a copy of the ISO disk (this link should be able to help https://github.com/virtio-win/virtio-win-pkg-scripts/blob/master/README.md), and run the installation script that is present on the disk.
This should install the virtio drivers.

## Setting up the runner script (Tested on Windows 10)
Within the VM, file with executable permissions in the folder C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
This script will run on startup, so one thing you can do is run all of the files within the cd drive that will be added by kubernetes.
The following line will suffice: `for %%i in (D:\*) do %%i`
This assumes that the malware is contained in the drive right after the drive containing the windows iso, which should work if you are using the automated script.

## Install CDI
In order to use DataVolumes, you need to install CDI. Instructions are found [here](https://kubevirt.io/labs/kubernetes/lab2.html). Specifically

```
export VERSION=$(curl -s https://github.com/kubevirt/containerized-data-importer/releases/latest | grep -o "v[0-9]\.[0-9]*\.[0-9]*")
kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-operator.yaml
kubectl create -f https://github.com/kubevirt/containerized-data-importer/releases/download/$VERSION/cdi-cr.yaml
```

## Uploading the Windows VM to Kubernetes
First, you should copy the qcow2 image that contains the hard drive contents of the VM that you just created to the location of the minikube cluster that you will be uploading to. At the very least, it needs to be able to access the CDI service.
Instructions on how to use the CDI service are here: https://kubevirt.io/user-guide/operations/containerized_data_importer/

To summarize, you will need to
 1) Create a datavolume that will store the qcow2 hard drive that will be referenced by the VMs
 An example YAML file would be 

```
apiVersion: cdi.kubevirt.io/v1beta1
kind: DataVolume
metadata:
  name: upload-datavolume
spec:
  source:
      upload: {}
  pvc:
    accessModes:
      - ReadWriteOnce
    resources:
      requests:
        storage: 30Gi
```
  You can then create this datavolume using the `kubevirt create -f <yaml_file_name>.
  You may need to change the "storage" size requirement depending on the size of your iso and how much space you have on kubernetes.

 2) Upload the qcow2 image to the CDI node. Normally, you are unable to access the CDI upload service. The way I used to access was port forwarding in a separate terminal instance while uploading a file. The port forwarding was done using this command:
    `kubectl port-forward -n cdi service /cdi-uploadproxy 8443:443`
 To upload the file <image-path> to the data volume <data-volume> (again, while the previous port-forwarding command runs):
    `virtctl image-upload dv <data-volume> --insecure  --image-path=<image-path>  --uploadproxy-url=https://localhost:8443`
 This will eventually show a loading bar in the terminal that will show progress when the data volume is ready. It may take a while to upload a large iso, 

## Creating VM instances
Now you can start creating VMs that run from this image. Use the `create_malware_vm.sh` script to generate copies of the virtual machine from this image to run specific malware. These Virtual Machines will be created as copies of the base image that you have used. This is caused by the `ephemeral` volume used for the drive. If you want to modify the image after it has been uploaded, you can always create a VirtualMachine Kubernetes specification that directly references the DataVolume containing the Windows ISO.\

If you want a graphical view of the malware, you can use the vnc command. Remember to use X11 forwarding `ssh -X` so that you can use the VNC command. Run `virtctl vnc <vm name>`. You can get the vm name using `kubectl get vm`. This command will also tell you if the vm is ready to be VNC-ed into.
