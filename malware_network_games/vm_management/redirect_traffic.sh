#!/bin/bash

set -e # Exit on errors
shopt -s expand_aliases
alias antrea="kubectl -n kube-system exec -i antrea-agent-h5slq  -c antrea-agent --"

if [ -z "$1" ]
then
 echo "Source container needs to be passed in"
 exit
fi

if [ -z "$2" ]
then
 echo "Destination container needs to be passed in"
 exit
fi

VMNAME=$1
MONITOR_NAME=$2

VM_PORT=$(antrea antctl get podinterface | grep $VMNAME | tr -s ' ' | cut -d' ' -f 3)
VM_MAC=$(antrea antctl get podinterface | grep $VMNAME | tr -s ' ' | cut -d' ' -f 5)
VM_REQUEST_TRAFFIC_ACTIONS=$(antrea ovs-ofctl dump-flows br-int table=10,ip,in_port=$VM_PORT | tail -n1 | rev | cut -d' ' -f1 | rev | tr -d '\n') # Get the last field, using rev
VM_RESPONSE_TRAFFIC_ACTIONS=$(antrea ovs-ofctl dump-flows br-int table=80,dl_dst=$VM_MAC | tail -n1 | rev | cut -d' ' -f1 | rev | tr -d '\n') # Get the last field, using rev

MONITOR_PORT=$(antrea antctl get podinterface | grep "$MONITOR_NAME" | tr -s ' ' | cut -d' ' -f 3)
echo " * VM Port: "$VM_PORT
echo " * Monitor Port: " $MONITOR_PORT

# Monitor traffic going out of the source
antrea ovs-ofctl mod-flows br-int "table=10,ip,in_port=$VM_PORT,$VM_REQUEST_TRAFFIC_ACTIONS,output:$MONITOR_PORT"
# Old command
# antrea ovs-ofctl mod-flows br-int "table=10,ip,in_port=$VM_PORT,actions=resubmit(,29),output:$MONITOR_PORT"
# Monitoring traffic going into the source
antrea ovs-ofctl mod-flows br-int "table=80,dl_dst=$VM_MAC,$VM_RESPONSE_TRAFFIC_ACTIONS,output:$MONITOR_PORT"
echo " ! Redirection Success"


