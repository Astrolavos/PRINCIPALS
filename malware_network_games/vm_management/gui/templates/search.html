<!--Structure of server copied from https://www.js-tutorials.com/jquery-tutorials/simple-example-jquery-autocomplete/, repurposed to handle binary function comparison.-->
<html lang="en">
<head>
   <meta charset="UTF-8">
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.devbridge-autocomplete/1.2.27/jquery.autocomplete.min.js"></script>
   <script src="{{ url_for('static', filename='node_modules/vis-network/standalone/umd/vis-network.min.js')}}"></script>

   <link href="{{ url_for('static', filename='node_modules/vis/dist/vis.css')}}" rel="stylesheet" type="text/css" />
   <link rel="stylesheet" href="{{ url_for('static', filename='graph_styles.css')}}">
   <title>Demo: Network View</title>
   <style>
   .autocomplete-suggestions { border: 1px solid #999; background: #FFF; overflow: auto; }
   .autocomplete-suggestion { padding: 2px 5px; white-space: nowrap; overflow: hidden; }
   .autocomplete-selected { background: #F0F0F0; }
   .autocomplete-suggestions strong { font-weight: normal; color: #3399FF; }
   .autocomplete-group { padding: 2px 5px; }
   .autocomplete-group strong { display: block; border-bottom: 1px solid #000; }

   .custom-menu {
   display: none;
   z-index: 1000;
   position: absolute;
   overflow: hidden;
   border: 1px solid #CCC;
   white-space: nowrap;
   font-family: sans-serif;
   background: #FFF;
   color: #333;
   border-radius: 5px;
   padding: 0;
   }

   /* Each of the items in the list */
   .custom-menu li {
   padding: 8px 12px;
   cursor: pointer;
   list-style-type: none;
   transition: all .3s ease;
   user-select: none;
   }

   .custom-menu li:hover {
   background-color: #DEF;
   }

   .side-window {
      overflow:hidden; 
   }

   .traffic-content {
      height: 85%;
      overflow: scroll;
   }

   .monitor-specific, .mitm-specific {
      display:none;
   }

   </style>
</head>
<body>
   <div class="" style="padding:10px 10px;">
   <h1>Demo : Network View</h1>

   <div class="">

      <div id="mynetwork" style="float:left; height:100%; width:60%"> </div>

      <div class="side-window">
         <h2 style="text-align:center">Details</h2>
         <pre id="side-window-details"></pre> 

         <div class="monitor-specific" >
            <h4>Monitor Settings</h4>
            <form>
               <input type="checkbox" id="auto_quarantine" name="auto_quarantine", value="Quarantine">
               <label for="auto_quarantine">Auto Quarantine</label>

               <input type="checkbox" id="traffic_monitoring" name="traffic_monitoring", value="Quarantine">
               <label for="traffic_monitoring">Enable Traffic Monitoring</label>
            </form>
         </div>

         <div class="monitor-specific mitm-specific"  id="side-window-traffic"> 
            <h3>Traffic</h3>
            <form id="traffic-refresh-form" action="get_monitor_traffic">
               <input type="checkbox" id="show_raw_dns" name="show_raw_dns", value="RawDNS">
               <label for="show_raw_dns">Show Raw DNS Traffic</label>

               <input type="checkbox" id="only_malicious" name="only_malicious", value="JustMalicious">
               <label for="only_malicious">Filter Known Benign Traffic</label>

               <input type="submit" name="submit" value="Refresh Traffic">
            </form>
         </div>
      </div>
   </div>

   
   <ul class='custom-menu' id="node-menu">
      <li data-action="create-c2">Create Fake C2</li>
      <li data-action="mitm">Spawn MitM</li>
      <li data-action="monitor">Spawn Monitor</li>
      <li data-action="delete">Delete</li>
   </ul>
   

    <ul class='custom-menu' id="network-menu">
      <li data-action="create-vm">Create VM</li>
      <li data-action="create-monitor">Create Monitor</li>
      <li data-action="create-test">Create Test Node</li>
      <li data-action="refresh-network">Refresh Network</li>
    </ul>
    
    <ul class='custom-menu' id="mitm-menu">
      <li data-action="delete">Delete</li>
   </ul>

   <ul class='custom-menu' id="c2-menu">
      <li data-action="delete">Delete</li>
   </ul>

    <ul class='custom-menu' id="monitor-menu">
      <li data-action="connect">Connect to VM</li>
      <li data-action="delete">Delete</li>
   </ul>



</body>
</html>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.js"></script>
<script type="text/javascript">

      // When the traffic form is submitted, inserts the active sidemenu node to the backend to get its traffic menu
      $("#traffic-refresh-form").submit(function(e) {
         var identifier = sideMenuNode.id
         e.preventDefault();

         refreshTraffic(identifier)
      }) 

      function refreshTraffic(identifier) {
         var form = $("#traffic-refresh-form");
         var actionURL = form.attr('action');
         form_data = form.serializeArray();
         form_data.push({'name': 'pod_name', 'value': identifier});
         form_data.push({'name': 'update_traffic_files', 'value': false});

         $.ajax({
            type: "POST",
            url: actionURL,
            data: form_data,
            async: true,
            dataType: 'json',
            timeout: refreshRate,
            success:  function(result){
               if (typeof result === 'string') {
                  $("#traffic-content-"+identifier).text(result);
               } else {
                  $("#traffic-content-"+identifier).text("");                  
               }
            },
            error: function(result) {
               console.log("Error: ", result); 
            }
         });
      }

      // Update the backend when the auto quarantine button is checked.
      $('#auto_quarantine').change(function(e) {
         var identifier = sideMenuNode.id
         var is_checked = $("#auto_quarantine").is(":checked")
         $.ajax({
            type: "POST",
            url: "set_node_details",
            data: JSON.stringify({
               "pod_name": identifier,
               "pod_settings": {"auto_quarantine_enabled": is_checked}
            }),
            async: true,
            contentType: "application/json; charset=utf-8",
            traditional: true,
            timeout: 1000,
            success:  function(result){
               console.log("Auto_quarantine: " + is_checked);
               refreshSideMenu(sideMenuNode)
            },
            error: function(result) {
               console.log("Error: ", result); 
            }
         });
      })
      $('#traffic_monitoring').change(function(e) {
         var identifier = sideMenuNode.id
         var is_checked = $("#traffic_monitoring").is(":checked")
         $.ajax({
            type: "POST",
            url: "set_node_details",
            data: JSON.stringify({
               "pod_name": identifier,
               "pod_settings": {"traffic_monitoring_enabled": is_checked}
            }),
            async: true,
            contentType: "application/json; charset=utf-8",
            traditional: true,
            timeout: 1000,
            success:  function(result){
               console.log("traffic_monitoring: " + is_checked);
               refreshSideMenu(sideMenuNode)
            },
            error: function(result) {
               console.log("Error: ", result); 
            }
         });
      })


      function toggleForm(){
         document.body.classList.toggle('activeForm');
      }

      var nodes = new vis.DataSet([]);
      var edges = new vis.DataSet([]);

      // create a network
      var container = document.getElementById("mynetwork");
      var data = {
        nodes: nodes,
        edges: edges,
      };
      var options = {
         nodes: {},
         edges: {}
      };
      var network = new vis.Network(container, data, options);
      var contextMenuNode = null;
      var sideMenuNode = null;
      // If you ask to connect a monitor to another node, it will keep it here
      // until you click another node.
      var monitorToConnect = null; 

      function getParentNodes(node) {
         connectedEdges = edges.get().filter(x => x['to'] == node)
         return connectedEdges.map(x=> x['from'])
      }

      function getChildNodes(node) {
         connectedEdges = edges.get().filter(x => x['from'] == node)
         return connectedEdges.map(x=> x['to'])
      }
      function getMatchingEdges(src, dst) {
         return edges.get().filter(x => x['from'] == src && x['to'] == dst)
      }

      function getConnectedNodes(node) {
         return getParentNodes(node).concat(getChildNodes(node))
      }


      function refreshNetwork() { 

         $.ajax({
            type: "GET",
            url: "get_nodes",
            async: true,
            dataType: 'json',
            timeout: 10000,
            success: function(data, status, xhr) {
               for (category in data) {
                  for (node of data[category]) {
                     edges_from = []
                     edges_to = []
                     if (category == 'vm') {
                        label = node['vm_name'];
                     } else {
                        label = node['label_name'] ?? node['pod_name'];
                     }

                     if (["monitor", 'mitm'].includes(category)) {
                        refreshTraffic(node['pod_name'])
                     }

                     // Add the node if it doesn't already exist
                     if (! (nodes.get(node['pod_name'])) ) {
                        addNode(node['pod_name'], label, category, [], []);
                        // This was for the feb 2022 ops 5g content
                        if (node['pod_name'] == 'core-router-monitor') {
                           // Connect to the lower level routers instead of the vms directly
                           edges.add({'from': '5g-cell-1-monitor', 'to': 'core-router-monitor'})
                           edges.add({'from': '5g-cell-2-monitor', 'to': 'core-router-monitor'})
                           edges.add({'from': '5g-cell-3-monitor', 'to': 'core-router-monitor'})
                           continue;
                        }
                        // This is for the sep 2022 presentation
                        if (node['pod_name'] == 'router-monitor') {
                           // Connect to the lower level routers instead of the vms directly
                           edges.add({'from': 'gateway-1-monitor', 'to': 'router-monitor'})
                           edges.add({'from': 'gateway-2-monitor', 'to': 'router-monitor'})
                           edges.add({'from': 'gateway-3-monitor', 'to': 'router-monitor'})
                           continue;
                        }
                     }


                     for (connecting_pod of (node['connections'] ?? [])) {
                        if (connecting_pod == 'core-router-monitor') {
                           continue;
                        }
                        if (connecting_pod == 'router-monitor') { // This is for the sep 2022 presentation
                           continue;
                        }


                        if (getMatchingEdges(node['pod_name'], connecting_pod).length == 0) {
                           edges.add({'from': node['pod_name'], 'to': connecting_pod});
                        }
                     }
                     for (connected_pod of getChildNodes(node['pod_name'])) {
                        if (connecting_pod == 'core-router-monitor') {
                           continue;
                        }
                        if (connecting_pod == 'router-monitor') { // This is for the sep 2022 presentation
                           continue;
                        }


                        if ( !(node['connections'].includes(connected_pod))) {
                           // This is an edge that should be removed, since it wasn't in the listed connections.
                           matched_edges = getMatchingEdges(node['pod_name'], connected_pod)
                           for (edge of matched_edges) {
                              edges.remove(edge.id);
                           }
                        }
                     }
                  }
               }
            },
            error: function(data, status, xhr) {
               console.log("AJAX error: ", data, status, xhr);
            }
         }); 
         
         
      }
      // If you want this to continually update the frontend with the latest 
      // data, uncomment the following lines
      var refreshRate = 3000;
      refreshNetwork();
      // const maliciousDomainCheck = setInterval(function() {
      //    checkTraffic();
      // }, refreshRate);

      const SideMenuRefresh = setInterval(function() {
         if (sideMenuNode != null && $("#traffic-content-"+sideMenuNode.id).is(":visible")) {
            refreshTraffic(sideMenuNode.id);
         }
      }, refreshRate);

      function checkTraffic() {
         $.ajax({
            type: "GET",
            url: "update_traffic",
            async: true,
            dataType: 'json',
            timeout: refreshRate,
            success:  function(data, status, xhr){
               console.log("Traffic check Successful");
            },
            error: function(data, status, xhr) {
               console.log("AJAX error: ", data, status, xhr);
            }
         });         
      }

      function addVM(name, sample_path) {
         $.ajax({
            type: "POST",
            url: "create_vm",
            data: {"node_label": name, "sample_path": sample_path},
            async: true,
            dataType: 'json',
            timeout: 60000,
            success:  function(data, status, xhr){
               console.log("Attempting to add node");
               if ('error' in data) {
                  console.log("ERROR: " + data['error']);
                  return;
               }
               refreshNetwork();
            },
            error: function(data, status, xhr) {
               console.log("AJAX error: ", data, status, xhr);
            }
         });
      }
      
      function addMonitor(identifier) {
         $.ajax({
            type: "POST",
            url: "create_monitor",
            data: {"node_label": identifier},
            async: true,
            dataType: 'json',
            timeout: 30000,
            success:  function(result){
               console.log("Created monitor");
               refreshNetwork();
            },
            error: function(result) {
               console.log(result);
            }
         });
      }

      function addMITM(pod_name, mitm_name, dga_fake_c2) {
         $.ajax({
            type: "POST",
            url: "create_mitm",
            data: {
               "pod_name": pod_name,
               "mitm_name": mitm_name,
               "dga_fake_c2": dga_fake_c2,
            },
            async: true,
            dataType: 'json',
            timeout: 30000,
            success:  function(result){
               console.log("Created monitor");
               refreshNetwork();
            },
            error: function(result) {
               console.log(result);
            }
         });
      }

      function connectVMToMonitor(vm_pod_name, monitor_pod_name) {
         $.ajax({
            type: "POST",
            url: "monitor_vm",
            data: {
               "vm_pod_name": vm_pod_name,
               "monitor_pod_name": monitor_pod_name,
            },
            async: true,
            dataType: 'json',
            timeout: 10000,
            success:  function(result){
               console.log("Connected " + vm_pod_name + " and " + monitor_pod_name);
               refreshNetwork();
            },
            error: function(result) {
               console.log(result);
            }
         });
      }

      function addNode(pod_name, label, nodeClass="", from=[], to=[]) {
         color="#3399FF";
         image="/static/laptop.png"
         if (nodeClass == "mitm") {
            image = "/static/network_management.jpg";
            color="orange";
         } else if (nodeClass == "monitor") {
            color="green";
            image = "/static/router.png";
         } else if (nodeClass == "c2") {
            color="red"
            image = "/static/network_management.jpg";
         }
         if (nodeClass == 'monitor' || nodeClass == 'mitm') {
            $("#side-window-traffic").append('<pre class="traffic-content" id="traffic-content-'+ pod_name + '"></pre>'); 
            $('#traffic-content-'+ pod_name).hide();
         }
         nodes.add({id:pod_name, label: label, nodeClass: nodeClass, color:color, shape:'image', image:image});
         for (source of from) {
            edges.add({from: source, to: pod_name});
         }
         for (dest of to) {
            edges.add({from: pod_name, to: dest});
         }
      }

      function deleteNode(label, category) {
         $.ajax({
                  type: "POST",
                  url: "delete_node",
                  data: {
                     "label": label,
                     "category": category,
                  },
                  async: false,
                  dataType: 'json',
                  timeout: 5000,
                  success:  function(result){
                     nodes.remove(contextMenuNode);
                  }
               });
      }

      // initialNodes = ["Alice", "Malice", "Other 1", "Other 2"]
      // for (n of initialNodes) {addNode(n)}

      network.on("oncontext", function (properties) {
         $(".custom-menu").hide(100);

         properties.event.preventDefault();
         test = properties;
         node = network.getNodeAt(properties.pointer.DOM);
         contextMenuNode = nodes.get(node);
         // If context menu is for a single node, show 
         var menuName = "";
         if (Array.isArray(contextMenuNode)) {
            menuName = "#network-menu";
         } else if (contextMenuNode.nodeClass == "mitm") {
            menuName = "#mitm-menu";
         } else if (contextMenuNode.nodeClass == "monitor") {
            menuName = "#monitor-menu";
         } else if (contextMenuNode.nodeClass == "c2") {
            menuName = "#c2-menu";
         } else {
            menuName = "#node-menu";
         }
         // Show contextmenu
         $(menuName).finish().toggle(100).
         
         // In the right position (the mouse)
         css({
            top: event.pageY + "px",
            left: event.pageX + "px"
         });
      });

      $("#node-menu li").click(function(){
         switch($(this).attr("data-action")) {
            case "delete": 
               deleteNode(contextMenuNode.label, 'vm')
               break;
            case "create-c2":
               var vm_pod_name = contextMenuNode.id
               var mitm_identifier = window.prompt("Enter mitm identifier: ");
               var dga_pattern = window.prompt("Enter dga pattern: ");
               addMITM(vm_pod_name, mitm_identifier, dga_pattern)
               break;
            case "mitm":
               var identifier = contextMenuNode.id
               var label = contextMenuNode.label
               $.ajax({
                  type: "POST",
                  url: "create_mitm",
                  data: {
                     "pod_name": identifier,
                     "mitm_name": label,
                  },
                  async: true,
                  dataType: 'json',
                  timeout: 30000,
                  success:  function(result){
                     console.log("Created mitm");
                     refreshNetwork();
                  },
                  error: function(result) {
                     console.log(result);
                  }
               });
               break;
            case "monitor":
               var identifier = contextMenuNode.id
               addMonitor(identifier)
               break;
         }
         contextMenuNode = null;
         // Hide it AFTER the action was triggered
         $("#node-menu").hide(100);
      });

      // If the context menu element is clicked
      $("#network-menu li").click(function(){
         switch($(this).attr("data-action")) {
            case "create-vm":
               var name = window.prompt("Enter node name: ");
               var sample_path = window.prompt("Enter sample path: ");
               if (name == "" || name == null) {
                  break;
               }
               addVM(name, sample_path);
               break;
            case "create-monitor":
               var identifier = window.prompt("Enter monitor identifier: ");
               addMonitor(identifier);
               break;
            case "create-test":
               addNode("test", "", [], []);
               break;
            case "refresh-network":
               refreshNetwork();
               break;
         }
         contextMenuNode = null;
         // Hide it AFTER the action was triggered
         $("#network-menu").hide(100);
      });

      // If the context menu element is clicked
      $("#monitor-menu li").click(function(){
         switch($(this).attr("data-action")) {
            case "get-traffic":
               var identifier = contextMenuNode.id
               $.ajax({
                  type: "POST",
                  url: "get_monitor_traffic",
                  data: {"node_label": identifier},
                  async: true,
                  dataType: 'json',
                  timeout: 10000,
                  success:  function(result){
                     // Approach pulled from https://stackoverflow.com/questions/16086162/handle-file-download-from-ajax-post
                     console.log("Pulling pcap")
                     console.log(result)
                     var blob=new Blob([result]);
                     var link=document.createElement('a');
                     link.href=window.URL.createObjectURL(blob);
                     link.download=identifier + "_traffic.txt";
                     link.click();
                     // document.getElementById("results").textContent=result;
                  },
                  error: function(result) {
                     console.log("Error: ", result); 
                  }
               });
               break;
            case "connect":
               monitorToConnect=contextMenuNode.id;
               break;
            case "delete":
               deleteNode(contextMenuNode.id, 'monitor')
               break;
         }
         contextMenuNode = null;
         // Hide it AFTER the action was triggered
         $("#monitor-menu").hide(100);
      });

      $("#mitm-menu li").click(function(){
         switch($(this).attr("data-action")) {
            case "delete":
               deleteNode(contextMenuNode.id, 'mitm');
               break;
         }
         contextMenuNode = null;
         // Hide it AFTER the action was triggered
         $("#mitm-menu").hide(100);
      });

      $("#c2-menu li").click(function(){
         switch($(this).attr("data-action")) {
            case "delete":
               deleteNode(contextMenuNode.id, 'c2');
               break;
         }
         contextMenuNode = null;
         // Hide it AFTER the action was triggered
         $("#c2-menu").hide(100);
      });

      network.on('click', function(properties) {
         // If the clicked element is not the menu
         if (!$(properties.target).parents(".custom-menu").length > 0) {
            // Hide it
            $(".custom-menu").hide(100);
         }

         // Get the clicked node.
         properties.event.preventDefault();
         var ids = properties.nodes;
         var clickedNodes = nodes.get(ids);
         if (clickedNodes == undefined || clickedNodes[0] == undefined) {
            return;
         }
         clickedNode = clickedNodes[0]

         // Handle if you are currently trying to connect a monitor with another node
         if (monitorToConnect != null) {
            if (clickedNode['nodeClass'] == 'vm') {
               connectVMToMonitor(clickedNode.id, monitorToConnect);
               return;
            }
            monitorToConnect = null;
         }

         refreshSideMenu(clickedNode);
      })

      // Unhide the new one, creating another one if needed.
      function refreshSideMenu(new_side_menu_node) {
            // Hide the old traffic view
            if (sideMenuNode != null) {
               old_traffic_window_id = "traffic-content-" + sideMenuNode.id
               $("#"+old_traffic_window_id).hide()
            }
            
            sideMenuNode = new_side_menu_node

            new_traffic_window_id = "traffic-content-" + sideMenuNode.id
            
            $(".monitor-specific").hide();
            $(".mitm-specific").hide();
            
            if (sideMenuNode.nodeClass == 'monitor') {
               $(".monitor-specific").show();
               $("#"+new_traffic_window_id).show()

            } else if (sideMenuNode.nodeClass == 'mitm') {
               $(".mitm-specific").show();
               $("#"+new_traffic_window_id).show()

            } else if (['vm'].includes(sideMenuNode.nodeClass)) {
               $("#side-window-traffic").hide();
            }



            // Get information on the clicked node
            $.ajax({
                     type: "POST",
                     url: "get_node_details",
                     data: {"pod_name": sideMenuNode.id},
                     async: true,
                     dataType: 'json',
                     success:  function(result){
                        document.getElementById("side-window-details").textContent=JSON.stringify(result, undefined, 2);
                        $("#auto_quarantine").prop("checked", result['auto_quarantine_enabled'] ?? false)
                        $("#traffic_monitoring").prop("checked", result['traffic_monitoring_enabled'] ?? false)
                     },
                     error: function(result) {
                        console.log("Error: ", result);
                     }
            });
         }


      
      // function loadSuggestions(data) {
      //    var filenames = data.map(function (entry) {
      //       return {'value':entry}
      //    });
      //    $('#autocomplete_filename').autocomplete({
      //       lookup: filenames,
      //       onSelect: function (suggestion) {
      //          $('#selected_option').html(suggestion.value);
      //          setupFunctionMenu(suggestion);
      //       }
      //    });
      // }
      
      // function setupFunctionMenu(filename) {
      //   $.ajax({
      //      url: "functions/" + filename.value,
      //      async: true,
      //      dataType: 'json',
      //      success: function (data) {
      //         $("#function_count").html(data.length);
      //         var functions = data.map(function (entry) {
      //            return {'value':entry}
      //         });
      //         //send parse data to autocomplete function
      //         $('#autocomplete_function').autocomplete({
      //            lookup: functions,
      //            onSelect: compareFunctions
      //         });
      //      }
      //   });
      //   // Placed here so it has access to the `filename` variable
      //   function compareFunctions(suggestion) {
           
      //      $.ajax({
      //         type: "POST",
      //         url: "search",
      //         data: {"filename": filename.value,"function_name": suggestion.value, "scoring_function": $("#autocomplete_scoring").val()},
      //         async: true,
      //         dataType: 'json',
      //         success: function (results) {
      //            main_func = results["main_func"]
      //            matches = results["matches"]
      //            graphFunc(main_func["nodes"], main_func["edges"], "mynetwork")
      //            for (let i = 0; i < 7; i++) {
      //             var m = matches[i];  
      //             graphFunc(m['nodes'], m['edges'], "mynetwork"+i);
      //            }
      //            $('#results').html(JSON.stringify(results['scores']));
      //         },
      //      });
      //   }
      // }
      // function graphFunc(nodes, edges, elementId) {
      //    var container = document.getElementById(elementId);
      //    var data = {
      //       nodes: nodes,
      //       edges: edges,
      //    };
      //    var options = {
      //       edges: {
      //          smooth: false,
      //       },
      //       height: "90%",
      //       layout: {
      //          hierarchical: {
      //             enabled: true,
      //             levelSeparation: 300,
      //             sortMethod: "directed",
      //             blockShifting: true,
      //             parentCentralization: true,
      //          },
      //       },
      //       manipulation: false,
      //       physics: {
      //          hierarchicalRepulsion: {nodeDistance: 300},
      //          solver: "hierarchicalRepulsion"
      //       }
      //    };
         // var network = new vis.Network(container, data, options);
      // }
   // });

 </script>