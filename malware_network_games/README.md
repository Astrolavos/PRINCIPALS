# **Demonstration Guide: Real-Time Malware Monitoring and MitM Intervention**  

## **Overview**  
This demonstration showcases a real-time malware monitoring and man-in-the-middle (MitM) intervention system within a Kubernetes-based cluster. The process involves executing malware samples, detecting specific behaviors, and dynamically intercepting network activity to modify or block malicious behaviors.  

## Dependencies
The kubernetes cluster used was setup with minikube and kubevirt.

## **Demonstration Workflow**  
1. Deploy malware within the cluster.  
2. Monitor its execution to identify specific malicious behaviors.  
3. Upon detecting the behavior, trigger the MitM system.  
4. The MitM intercepts and blocks certain behaviors, demonstrating the impact of intervention.  

## **Implementation Details**  
### **Detection and MitM Triggering**  
- The system continuously monitors malware activity.  
- A file synchronization mechanism parses logs every second to check for queried domains.  
- Upon identifying a suspicious domain, the MitM system is activated to intercept and modify network behavior in real time.  

## **Setup Requirements**  
To ensure the demonstration runs smoothly, the following components must be operational:  

### **Frontend & Backend Services**  
- **GUI Synchronization**: Execute `file_synch.py` in the `gui` directory to reflect updates on the front end.  
- **Backend Flask API**: Start the Flask server on port `5002`:  
  ```bash
  export FLASK_APP=server  
  flask run -p 5002  
  ```  

### **Kubernetes Cluster Configuration**  
- **Filesystem Mounting for Minikube** (Required for KubeVirt):  
  ```bash
  minikube -p gt-cluster mount <path to scripts folder>:/hosthome  
  ```  
  This enables the use of scripts within the containers.

- **Port Forwarding for CDI Upload Proxy** (Required for malware ISO uploads):  
  Malware ISOs are uplaoded using the CDI upload proxy. To enable that, use kubectl.
  ```bash
  kubectl port-forward -n cdi service/cdi-uploadproxy 8443:443  
  ```  

By following this guide, you will be able to successfully execute and observe the malware monitoring and intervention process in a controlled environment.



### Actors
* `VM1`: application that generated benign traffic
* `VM2`: application that generated malicious traffic
* `monitor-generic`: flexible monitoring application with elevated priviledges and capabilites.
* `monitor-specific`: mitm application

### Scenario Setup

```
                                          _____________________________________________________ 
                                          |                                                    |
------------------------------            |                                monitor-generic     |
|       monitor-generic      |            |                                     |              |
| VM1 --\       |            |     ====\  | VM1 ---->| monitor-specific| -\      |             |
|       |========== gateway  |     ====/  |                               |========== gateway  |
| VM2 --/                    |            | VM2 --------------------------/                    |
------------------------------            ------------------------------------------------------
 ```


* `monitor-generic` receives mirrored traffic from `VM1` and `VM2`.
* `VM2` initiated a connection with the C2 domain.
* `monitor-generic` spawns `monitor-specific` and attaches it to the `VM2` path (mitm)
* `VM2` drops any TCP traffic to the C2 domain while allowing for everything else

## Assumptions
* The C2 server IP is X and can is reachable


## How to Play
* Antrea and Minikube required ([How to setup](https://github.gatech.edu/Astrolavos/PRINCIPALS/tree/master/gt/cluster-conf) - also can look wiki)
* To create the `VM1` and `VM2` pods (stopped state) run the `actors/play.sh`


# Pulling up virtual machines
To pull up the benign VM, Alice, within the `vm_management` folder run `./create_malware_vm.sh -s ./fake-malware.bat -i alice`. This will just curl for `yahoo.com` indefinitely, pausing for 3 seconds between requests.
To pull up the malicious VM, copy the blacknet2 malware onto the machine and run `./create_malware_vm.sh -s <path to blacknet> -i malicious`. A copy of the file is included in a zip folder with password infected.


