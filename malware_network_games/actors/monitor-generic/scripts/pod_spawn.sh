#!/usr/bin/env bash



readonly ANTREA_AGENT=$(kubectl get -A po | grep "antrea-agent-" | awk '{print $2}')
readonly ANTREA_COMMAND="kubectl -n kube-system exec -it $ANTREA_AGENT -c antrea-agent -- "

# create a container
MONITOR_NAME=$1
TARGET_IP=$2
kubectl create -f ${MONITOR_NAME}.yaml 

# enable MITM functionality
sleep 10 # wait a bit for pods to start
monitoring_inport=$(${ANTREA_COMMAND} antctl get podinterface ${MONITOR_NAME} | tail -n 1 | awk -F ' ' '{ print $3 }')
target_inport=$(${ANTREA_COMMAND} antctl get podinterface | grep $TARGET_IP | awk '{ print $3 }')
echo "in-port for ${MONITOR_NAME} -> ${monitoring_inport}"
echo "target port -> ${target_inport}"

new_rule=$(${ANTREA_COMMAND} ovs-ofctl dump-flows br-int | grep "alice-te" | grep "table=10"| grep -oPz 'ip,in_port(.*\n)' | sed -e 's/\s\+/,/g' | sed s/"resubmit(,29),"//)output:\"${monitoring_inport}\"
echo "Adding rule   ${new_rule}"
#${ANTREA_COMMAND} ovs-ofctl mod-flows br-int table=10,${new_rule}
#${ANTREA_COMMAND} ovs-ofctl add-flow br-int table=10,ip,in_port="$monitoring_inport",actions="resubmit(,29)"
