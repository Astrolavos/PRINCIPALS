#!/bin/bash

SCRIPT=`realpath $0`
SCRIPTPATH=`dirname $SCRIPT`

monitoring1_name="monitor-generic"

ANTREA_POD=$(minikube -p gt-cluster kubectl -- -n kube-system get po | grep antrea-agent- | cut -d" " -f1)
echo "Antrea pod name=${ANTREA_POD}"
ANTREA_COMMAND="minikube -p gt-cluster kubectl -- -n kube-system exec -it ${ANTREA_POD} -c antrea-agent --"

# create all the necessary containers
VM1_name="win10vm-alice"
echo "Starting $VM1_name..."
$SCRIPTPATH/create_malware_vm.sh -s $SCRIPTPATH/query_yahoo.bat -i alice

VM2_name="win10vm-malice"
echo "Starting $VM2_name..."
$SCRIPTPATH/create_malware_vm.sh -s $SCRIPTPATH/blacknet_malware2.exe -i malice

echo "Starting monitoring VM..."
eval $(minikube -p gt-cluster docker-env) 
docker build -f $SCRIPTPATH/monitor-generic/Dockerfile -t mitm-image .
minikube -p gt-cluster kubectl -- apply -f $SCRIPTPATH/monitor-generic/monitoring-role.yaml 
minikube -p gt-cluster kubectl -- create -f $SCRIPTPATH/monitor-generic/monitor-generic.yaml 
echo "Building mitm container for later.."
docker build -f $SCRIPTPATH/monitor-specific/Dockerfile -t mitm-image-2 .


# enable outgoing traffic mirroring
sleep 10 # wait a bit for pods to start
$SCRIPTPATH/redirect_traffic.sh $VM1_name $monitoring1_name
$SCRIPTPATH/redirect_traffic.sh $VM2_name $monitoring1_name

